<div>
  <ngx-spinner
    [name]="LOADERID"
    [fullScreen]="false"
    type="square-jelly-box"
    size="medium"
  ></ngx-spinner>

  <div class="row">
    <button matTooltip="Ajouter" *ngIf="!onAdd" mat-fab (click)="onAdd = true" type="button" color="primary">
      <em class="fa fa-plus fa-lg"></em>
    </button>
    <button matTooltip="Liste" *ngIf="onAdd" (click)="onAdd = false; loadListReferentiel()" mat-fab type="button" color="primary">
      <em class="fa fa-list fa-lg"></em>
    </button>
  </div>

  <app-referentiel-add *ngIf="onAdd"></app-referentiel-add>

  <div *ngIf="!onAdd" class="row" style="margin-bottom: 5%">
    <div class="text-center" style="margin-bottom: 3%">
      <h3>Liste référentiels</h3>
    </div>
    <div class="col-md-6 col-lg-6 col-sm-12 col-xs-12">
      <div class="col-md-10 col-lg-5 col-sm-12 col-xs-12">
        <div class="form-group row">
          <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
            <mat-form-field class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
              <mat-label>Niveau :</mat-label>
              <mat-select>
                <mat-option>Niveau 1</mat-option>
                <mat-option>Niveau 2</mat-option>
                <mat-option>Niveau 3</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>
      </div>
      <div class="col-md-10 col-lg-5 col-sm-12 col-xs-12">
        <div class="form-group row">
          <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
            <mat-form-field class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
              <mat-label>Spécialité :</mat-label>
              <mat-select>
                <mat-option>Spécialité 1</mat-option>
                <mat-option>Spécialité 2</mat-option>
                <mat-option>Spécialité 3</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>
      </div>
      <div class="col-md-10 col-lg-2 col-sm-12 col-xs-12">
        <button
          mat-mini-fab
          color="primary"
          style="background-color: whitesmoke; color: black"
          data-toggle="modal"
          data-target="#addModal"
        >
          <em class="fa fa-search fa-lg"></em>
        </button>
      </div>
    </div>
    <div class="col-md-6 col-lg-6 col-sm-12 col-xs-12">
      <mat-card>
        <div class="row">
          <div class="col-md-6 col-lg-6 col-sm-12 col-xs-12">
            <p>
              <em class="fa fa-square" style="color: rgb(161, 32, 32)"></em
              >&nbsp;&nbsp;69 classes à programme vide
            </p>
          </div>
          <div class="col-md-6 col-lg-6 col-sm-12 col-xs-12">
            <p>
              <em class="fa fa-square" style="color: rgb(161, 32, 32)"></em
              >&nbsp;&nbsp;69 classes à programme vide
            </p>
          </div>
          <div class="col-md-6 col-lg-6 col-sm-12 col-xs-12">
            <p>
              <em class="fa fa-square" style="color: rgb(161, 32, 32)"></em
              >&nbsp;&nbsp;69 classes à programme vide
            </p>
          </div>
          <div class="col-md-6 col-lg-6 col-sm-12 col-xs-12">
            <p>
              <em class="fa fa-square" style="color: rgb(161, 32, 32)"></em
              >&nbsp;&nbsp;69 classes à programme vide
            </p>
          </div>
          <div class="col-md-6 col-lg-6 col-sm-12 col-xs-12">
            <p>
              <em class="fa fa-square" style="color: rgb(161, 32, 32)"></em
              >&nbsp;&nbsp;69 classes à programme vide
            </p>
          </div>
          <div class="col-md-6 col-lg-6 col-sm-12 col-xs-12">
            <p>
              <em class="fa fa-square" style="color: rgb(161, 32, 32)"></em
              >&nbsp;&nbsp;69 classes à programme vide
            </p>
          </div>
          <div class="col-md-6 col-lg-6 col-sm-12 col-xs-12">
            <p>
              <em class="fa fa-square" style="color: rgb(161, 32, 32)"></em
              >&nbsp;&nbsp;69 classes à programme vide
            </p>
          </div>
          <div class="col-md-6 col-lg-6 col-sm-12 col-xs-12">
            <p>
              <em class="fa fa-square" style="color: rgb(161, 32, 32)"></em
              >&nbsp;&nbsp;69 classes à programme vide
            </p>
          </div>
        </div>
      </mat-card>
    </div>
  </div>

  <mat-card id="tableCard" *ngIf="!onAdd">
    <table class="table table-striped table-responsive">
      <thead>
        <tr>
          <th>Année</th>
          <th>Crédit</th>
          <th>VHT</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <ng-container
          *ngFor="
            let referentiel of listReferentiel
              | paginate: { itemsPerPage: 5, currentPage: page };
            let i = index
          "
        >
          <tr>
            <td>{{ referentiel.annee }}</td>
            <td>{{ referentiel.credit }}</td>
            <td>{{ referentiel.volumeHeureTotal }}</td>
            <td>
              <button
                style="background: transparent"
                matTooltip="Ajouter"
                mat-flat-button
              >
                <em class="fa fa-plus fa-lg"> </em>
              </button>
              &nbsp;&nbsp;
              <!-- <button
                style="background: transparent"
                (click)="
                  referentiel.expanded = !referentiel.expanded;
                  loadListProgrammeUE(referentiel)
                "
                matTooltip="Lister"
                mat-flat-button
              >
                <em class="fa fa-list fa-lg"> </em>
              </button> -->
            </td>
          </tr>

          <ng-container *ngIf="referentiel.expanded" [@flyInOut]>
            <ngx-spinner
              [name]="LOADERPROGRAMMEUE"
              [fullScreen]="false"
              type="square-jelly-box"
              size="medium"
            ></ngx-spinner>
            <tr>
              <th>Désignation</th>
              <th>Semestre</th>
              <th>Crédit</th>
              <th>Fondamental</th>
              <th>Nombre heure UE</th>
              <th>
                Actions&nbsp;&nbsp;
                <button
                  style="background: transparent"
                  type="button"
                  (click)="
                    expandedNewProgrammeUE = !expandedNewProgrammeUE;
                    onAddNewProgrammeUE()
                  "
                  mat-flat-button
                  matTooltip="Ajouter"
                >
                  <em class="fa fa-plus fa-lg"></em>
                </button>
              </th>
            </tr>

            <!-- form to add new programme ue -->
            <ng-container *ngIf="expandedNewProgrammeUE" [@flyInOut]>
              <tr>
                <td>
                  <mat-form-field
                    class="col-lg-12 col-md-12 col-sm-12 col-xs-12"
                  >
                    <mat-select
                      required
                      name="ue"
                      [(ngModel)]="ueModel"
                      [placeholder]="
                        ueModel
                          ? ueModel.libelle
                            ? ueModel.libelle
                            : 'Selectionnez l\'ue'
                          : 'Selectionnez l\'ue'
                      "
                    >
                      <mat-option *ngFor="let ue of listUe" [value]="ue">{{
                        ue?.libelle
                      }}</mat-option>
                    </mat-select>
                  </mat-form-field>
                </td>
                <td>
                  <mat-form-field
                    class="col-lg-12 col-md-12 col-sm-12 col-xs-12"
                  >
                    <mat-select
                      required
                      name="semestre"
                      [(ngModel)]="semestreModel"
                      [placeholder]="
                        semestreModel
                          ? semestreModel.libelle
                            ? semestreModel.libelle
                            : 'Selectionnez le semestre'
                          : 'Selectionnez le semestre'
                      "
                    >
                      <mat-option
                        *ngFor="let semestre of listSemestre"
                        [value]="semestre"
                        >{{ semestre?.libelle }}</mat-option
                      >
                    </mat-select>
                  </mat-form-field>
                </td>

                <td>
                  <mat-form-field
                    class="col-lg-12 col-md-12 col-sm-12 col-xs-12"
                  >
                    <mat-label>Crédit : </mat-label>
                    <input
                      [(ngModel)]="programmeUEModel.credit"
                      required
                      name="credit"
                      matInput
                    />
                  </mat-form-field>
                </td>
                <td>
                  <mat-form-field
                    class="col-lg-12 col-md-12 col-sm-12 col-xs-12"
                  >
                    <mat-label>Fondamental : </mat-label>
                    <input
                      [(ngModel)]="programmeUEModel.fondamental"
                      required
                      name="fondamental"
                      matInput
                    />
                  </mat-form-field>
                </td>
                <td>
                  <mat-form-field
                    class="col-lg-12 col-md-12 col-sm-12 col-xs-12"
                  >
                    <mat-label>Nombre heure UE : </mat-label>
                    <input
                      [(ngModel)]="programmeUEModel.nbreHeureUE"
                      required
                      name="nbreHeureUE"
                      matInput
                    />
                  </mat-form-field>
                </td>
                <td>
                  <!-- <button
                    (click)="saveProgrammeUE(referentiel)"
                    mat-raised-button
                    color="primary"
                    type="button"
                  >
                    Enregistrer
                    <em class="fa fa-save fa-lg"></em>
                  </button> -->
                </td>
              </tr>
            </ng-container>
            <!-- End form to add new programme ue -->

            <!-- list programme ue by referentiel-->
            <ng-container *ngFor="let programmeUE of listProgrammeUE">
              <tr>
                <td>{{ programmeUE.ue.libelle }}</td>
                <td>{{ programmeUE.semestre.libelle }}</td>
                <td>{{ programmeUE.credit }}</td>
                <td>{{ programmeUE.fondamental }}</td>
                <td>{{ programmeUE.nbreHeureUE }}</td>
                <td>L3</td>
                <td>
                  <button
                    style="background: transparent"
                    matTooltip="Modifier"
                    mat-flat-button
                  >
                    <em class="fa fa-edit fa-lg"> </em>
                  </button>
                  &nbsp;&nbsp;
                  <button
                    style="background: transparent"
                    matTooltip="Suprimmer"
                    mat-flat-button
                  >
                    <em class="fa fa-trash fa-lg"> </em>
                  </button>
                  &nbsp;&nbsp;
                  <button
                    (click)="
                      programmeUE.expanded = !programmeUE.expanded;
                      loadListProgrammeModule(programmeUE)
                    "
                    style="background: transparent"
                    matTooltip="Lister"
                    mat-flat-button
                  >
                    <em class="fa fa-list fa-lg"> </em>
                  </button>
                </td>
              </tr>

              <!-- list Programme module by programme ue -->
              <ng-container *ngIf="programmeUE.expanded">
                <tr>
                  <th>Nom</th>
                  <th>Budget</th>
                  <th>Coef</th>
                  <th>Nbre Crédit module</th>
                  <th>TD</th>
                  <th>TP</th>
                  <th>TPE</th>
                  <th>VH</th>
                  <th>VHT</th>
                  <th>
                    Actions&nbsp;&nbsp;
                    <button
                      style="background: transparent"
                      type="button"
                      (click)="
                        expandedNewProgrammeModule = !expandedNewProgrammeModule;
                        onAddNewProgrammeModule()
                      "
                      mat-flat-button
                      matTooltip="Ajouter"
                    >
                      <em class="fa fa-plus fa-lg"></em>
                    </button>
                  </th>
                </tr>

                <!-- form to add new ProgrammeModule -->
                <ng-container *ngIf="expandedNewProgrammeModule" [@flyInOut]>
                  <tr>
                    <td>
                      <mat-form-field
                        class="col-lg-12 col-md-12 col-sm-12 col-xs-12"
                      >
                        <mat-select
                          required
                          name="module"
                          [(ngModel)]="moduleModel"
                          [placeholder]="
                            moduleModel
                              ? moduleModel.libelle
                                ? moduleModel.libelle
                                : 'Selectionnez le module'
                              : 'Selectionnez le module'
                          "
                        >
                          <mat-option
                            *ngFor="let module of listModule"
                            [value]="module"
                            >{{ module?.libelle }}</mat-option
                          >
                        </mat-select>
                      </mat-form-field>
                    </td>
                    <td>
                      <mat-form-field
                        class="col-lg-12 col-md-12 col-sm-12 col-xs-12"
                      >
                        <mat-label>Budget : </mat-label>
                        <input
                          [(ngModel)]="programmeModuleModel.budget"
                          required
                          name="budget"
                          matInput
                        />
                      </mat-form-field>
                    </td>
                    <td>
                      <mat-form-field
                        class="col-lg-12 col-md-12 col-sm-12 col-xs-12"
                      >
                        <mat-label>Coef : </mat-label>
                        <input
                          [(ngModel)]="programmeModuleModel.coef"
                          required
                          name="coef"
                          matInput
                        />
                      </mat-form-field>
                    </td>
                    <td>
                      <mat-form-field
                        class="col-lg-12 col-md-12 col-sm-12 col-xs-12"
                      >
                        <mat-label>Nbre credit module : </mat-label>
                        <input
                          [(ngModel)]="programmeModuleModel.nbreCreditModule"
                          required
                          name="nbreCreditModule"
                          matInput
                        />
                      </mat-form-field>
                    </td>
                    <td>
                      <mat-form-field
                        class="col-lg-12 col-md-12 col-sm-12 col-xs-12"
                      >
                        <mat-label>TD : </mat-label>
                        <input
                          [(ngModel)]="programmeModuleModel.td"
                          required
                          name="td"
                          matInput
                        />
                      </mat-form-field>
                    </td>
                    <td>
                      <mat-form-field
                        class="col-lg-12 col-md-12 col-sm-12 col-xs-12"
                      >
                        <mat-label>TP : </mat-label>
                        <input
                          [(ngModel)]="programmeModuleModel.tp"
                          required
                          name="tp"
                          matInput
                        />
                      </mat-form-field>
                    </td>
                    <td>
                      <mat-form-field
                        class="col-lg-12 col-md-12 col-sm-12 col-xs-12"
                      >
                        <mat-label>TPE : </mat-label>
                        <input
                          [(ngModel)]="programmeModuleModel.tpe"
                          required
                          name="tpe"
                          matInput
                        />
                      </mat-form-field>
                    </td>
                    <td>
                      <mat-form-field
                        class="col-lg-12 col-md-12 col-sm-12 col-xs-12"
                      >
                        <mat-label>VH : </mat-label>
                        <input
                          [(ngModel)]="programmeModuleModel.vh"
                          required
                          name="vh"
                          matInput
                        />
                      </mat-form-field>
                    </td>
                    <td>
                      <mat-form-field
                        class="col-lg-12 col-md-12 col-sm-12 col-xs-12"
                      >
                        <mat-label>VHT : </mat-label>
                        <input
                          [(ngModel)]="programmeModuleModel.vht"
                          required
                          name="vht"
                          matInput
                        />
                      </mat-form-field>
                    </td>
                    <td>
                      <button
                        mat-raised-button
                        color="primary"
                        type="button"
                        (click)="saveProgrammeModule(programmeUE)"
                      >
                        Enregistrer
                        <em class="fa fa-save fa-lg"></em>
                      </button>
                    </td>
                  </tr>
                </ng-container>
                <!-- End form to add new ProgrammeModule -->

                <!-- list container ProgrammeModule -->
                <ng-container
                  *ngFor="let programmeModule of listProgrammeModule"
                >
                  <tr>
                    <td>{{ programmeModule.module.libelle }}</td>
                    <td>{{ programmeModule.budget }}</td>
                    <td>{{ programmeModule.coef }}</td>
                    <td>{{ programmeModule.nbreCreditModule }}</td>
                    <td>{{ programmeModule.td }}</td>
                    <td>{{ programmeModule.tp }}</td>
                    <td>{{ programmeModule.tpe }}</td>
                    <td>{{ programmeModule.vh }}</td>
                    <td>{{ programmeModule.vht }}</td>
                    <td>
                      <button
                        style="background: transparent"
                        matTooltip="Modifier"
                        mat-flat-button
                      >
                        <em class="fa fa-edit fa-lg"> </em>
                      </button>
                      &nbsp;&nbsp;
                      <button
                        style="background: transparent"
                        matTooltip="Suprimmer"
                        mat-flat-button
                      >
                        <em class="fa fa-trash fa-lg"> </em>
                      </button>
                    </td>
                  </tr>
                </ng-container>
                <!-- End list container ProgrammeModule -->
              </ng-container>
              <!-- end list Programme module by programme ue -->
            </ng-container>
            <!-- list programme ue by referentiel-->
          </ng-container>
        </ng-container>
      </tbody>
    </table>
  </mat-card>

  <table mat-table
       [dataSource]="listReferentiel" multiTemplateDataRows
       class="mat-elevation-z8">

  <ng-container matColumnDef="annee">
    <th mat-header-cell *matHeaderCellDef> Année </th>
    <td mat-cell *matCellDef="let row"> {{row.annee}} </td>
  </ng-container>

  <ng-container matColumnDef="credit">
    <th mat-header-cell *matHeaderCellDef> Crédit </th>
    <td mat-cell *matCellDef="let row"> {{row.credit}} </td>
  </ng-container>

  <ng-container matColumnDef="vht">
    <th mat-header-cell *matHeaderCellDef> VHT </th>
    <td mat-cell *matCellDef="let row"> {{row.volumeHeureTotal}} </td>
  </ng-container>

  <ng-container matColumnDef="actions">
    <th mat-header-cell *matHeaderCellDef> Actions </th>
    <td mat-cell *matCellDef="let row">
      <button type="button" mat-flat-button class="action-button"><em class="fa fa-edit fa-lg"></em></button>
      &nbsp;&nbsp;
      <button type="button" mat-flat-button class="action-button"><em class="fa fa-trash fa-lg"></em></button>
      &nbsp;&nbsp;
      <button type="button" mat-flat-button class="action-button"
        (click)="expandedReferentiel = expandedReferentiel === row ? null : row; loadSemestreNiveauList(row.niveau)"
        [class.example-expanded-row]="expandedReferentiel === row">
        <em class="fa fa-list fa-lg"></em>
      </button>
    </td>
  </ng-container>

  <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
  <ng-container matColumnDef="expandedDetail">
    <td mat-cell *matCellDef="let element" [attr.colspan]="referentielColumnsToDisplay.length">
      <div class="example-element-detail"
           [@flyInOut]="element == expandedReferentiel ? 'expanded' : 'collapsed'">
            <mat-accordion>
              <!-- liste des semestres par niveau du referentiel -->
              <mat-expansion-panel *ngFor="let s of listSemestreNiveau" (opened)="loadListProgrammeUE(element, s.semestre)">
                <mat-expansion-panel-header>
                  {{s.semestre.libelle}}
                </mat-expansion-panel-header>
                <ng-template matExpansionPanelContent>
                  <!-- formulaire ajout programme UE -->
                  <ng-container *ngIf="expandedNewProgrammeUE" [@flyInOut]>
                    <div class="row">
                      <div class=" col-lg-offset-1 col-md-offset-1 col-lg-2 col-md-2 col-sm-12 col-xs-12">
                        <mat-form-field class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                          <mat-select required name="ue" [(ngModel)]="ueModel"
                            [placeholder]="ueModel ? ueModel.libelle ? ueModel.libelle : 'Selectionnez l\'ue' : 'Selectionnez l\'ue'">
                            <mat-option *ngFor="let ue of listUe" [value]="ue">{{ ue?.libelle }}</mat-option>
                          </mat-select>
                        </mat-form-field>
                      </div>

                      <div class="col-lg-2 col-md-2 col-sm-12 col-xs-12">
                        <mat-form-field class="col-lg-12 col-md-12 col-sm-12 col-xs-12" >
                          <mat-label>Crédit : </mat-label>
                          <input [(ngModel)]="programmeUEModel.credit"  required name="credit" matInput />
                        </mat-form-field>
                      </div>

                      <div class="col-lg-2 col-md-2 col-sm-12 col-xs-12">
                        <mat-form-field class="col-lg-12 col-md-12 col-sm-12 col-xs-12" >
                          <mat-label>Fondamental : </mat-label>
                          <input [(ngModel)]="programmeUEModel.fondamental" required  name="fondamental" matInput />
                        </mat-form-field>
                      </div>

                      <div class="col-lg-2 col-md-2 col-sm-12 col-xs-12">
                        <mat-form-field class="col-lg-12 col-md-12 col-sm-12 col-xs-12" >
                          <mat-label>Nombre heure UE : </mat-label>
                          <input [(ngModel)]="programmeUEModel.nbreHeureUE" required name="nbreHeureUE" matInput />
                        </mat-form-field>
                      </div>

                      <div class="col-lg-2 col-md-2 col-sm-12 col-xs-12">
                        <button (click)="saveProgrammeUE(element, s.semestre)"  mat-raised-button class="action-button" type="button" >
                          Enregistrer
                          <em class="fa fa-save fa-lg"></em>
                        </button>
                      </div>
                    </div>
                  </ng-container>
                  <!-- END formulaire ajout programme UE -->

                  <!-- tableau pour afficher la liste de programme UE -->
                  <table mat-table [dataSource]="listProgrammeUE" multiTemplateDataRows>

                    <ng-container matColumnDef="designation">
                      <th mat-header-cell *matHeaderCellDef> Designation </th>
                      <td mat-cell *matCellDef="let programmeUe"> {{programmeUe.ue.libelle}} </td>
                    </ng-container>

                    <ng-container matColumnDef="creditProgrammeUe">
                      <th mat-header-cell *matHeaderCellDef> Crédit </th>
                      <td mat-cell *matCellDef="let programmeUe"> {{programmeUe.credit}} </td>
                    </ng-container>

                    <ng-container matColumnDef="fondamental">
                      <th mat-header-cell *matHeaderCellDef> Fondamental </th>
                      <td mat-cell *matCellDef="let programmeUe"> {{programmeUe.fondamental}} </td>
                    </ng-container>

                    <ng-container matColumnDef="nbrHeureUE">
                      <th mat-header-cell *matHeaderCellDef> Nombre Heure UE </th>
                      <td mat-cell *matCellDef="let programmeUe"> {{programmeUe.nbreHeureUE}} </td>
                    </ng-container>

                    <ng-container matColumnDef="actionsProgrammeUE">
                      <th mat-header-cell *matHeaderCellDef>
                        Actions &nbsp;&nbsp;
                        <button class="action-button" type="button" (click)="expandedNewProgrammeUE = !expandedNewProgrammeUE; onAddNewProgrammeUE()" mat-flat-button matTooltip="Ajouter">
                          <em class="fa fa-plus fa-lg"></em>
                        </button>
                      </th>
                      <td mat-cell *matCellDef="let programmeUe">
                        <button type="button" mat-flat-button class="action-button"><em class="fa fa-edit fa-lg"></em></button>
                        &nbsp;&nbsp;
                        <button type="button" mat-flat-button class="action-button"><em class="fa fa-trash fa-lg"></em></button>
                        &nbsp;&nbsp;
                        <button type="button" mat-flat-button class="action-button"
                          (click)="expandedProgrammeUE = expandedProgrammeUE === programmeUe ? null : programmeUe"
                          [class.example-expanded-row]="expandedProgrammeUE === programmeUe">
                          <em class="fa fa-list fa-lg"></em>
                        </button>
                      </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="programmeUEColumnsToDisplay"></tr>
                    <tr mat-row *matRowDef="let element; columns: programmeUEColumnsToDisplay;"
                      class="example-element-row">
                  </table>
                  <!-- END tableau pour afficher la liste de programme UE -->
                </ng-template>
                </mat-expansion-panel>
             </mat-accordion>
      </div>
    </td>
  </ng-container>

  <tr mat-header-row *matHeaderRowDef="referentielColumnsToDisplay"></tr>
  <tr mat-row *matRowDef="let element; columns: referentielColumnsToDisplay;"
      class="example-element-row">
  </tr>
  <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>
</table>

</div>
